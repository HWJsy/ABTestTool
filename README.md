# ABTestTool 使用文档

## 1. 使用流程概述
![alt text](image-1.png)
## 2. “文件”菜单栏
![alt text](image.png)
### 2.1 新建
点击后，在弹窗中，选择保存文件夹，输入文件名。新建的文件会被保存为 `[文件名].redabproj` 文件
![alt text](image-2.png)
### 2.2 打开
点击后，选择并打开一个 `.redabproj` 文件。其他类型的文件无法被选择。
![alt text](image-3.png)
### 2.3 工程设置
点击“cpp导出路径”后，在弹窗中选择导出cpp代码的路径
![alt text](image-4.png)
### 2.4 导出
点击“导出”或按下快捷键 `option + commond + s` 将版本管理模块中的最新版本导出为cpp代码，导出的文件为 `ABTest.hpp` 和 `ABTest.cpp`。

## 3. 功能开关模块
- 功能开关为程序在业务逻辑中实现测试分支的判断条件  
![alt text](image-5.png)
功能名称：描述该功能的作用  
函数名称：导出的代码中该功能对应的函数名  
返回类型：该功能对应的函数的返回类型  
默认值：该功能的默认返回值  
互斥开关(可选)：只可对返回类型为bool的功能设置互斥开关。  

### 3.1 新建功能
| 返回类型为 bool | 返回类型为非 bool |
| --------------- | ------------------ |
| ![alt text](image-6.png)<br/>返回类型为 **bool** | ![alt text](image-7.png)<br/>返回类型为 **非bool** |


- 新建功能时，输入的“功能名称”与“函数名称”不可为空、不可与已有的功能重复
- “函数名称”需满足C++命名要求：只能包含字母、数字和下划线，且不能以数字开头
- 当返回类型为bool时，需选择默认值为false或者true
- 当返回类型为非bool时，需要自定义默认返回值  
  - “Value”为默认返回值，“默认Key”为返回值的描述  
  - “默认Key”和“Value”不可为空  
  - “Value”的值需要满足返回值类型

### 3.2 设置分组互斥开关
![alt text](image-8.png)
- 互斥开关的作用：当多个功能使用同一个互斥开关时，在同一个分组中，这几个功能至多只能有一个处于开启状态。
- 添加互斥开关：  
  - 输入互斥开关的名称，点击“确定”按钮即可创建一个互斥开关。  
  - 新创建的互斥开关与已有的互斥开关的名称不可重复
- 编辑互斥开关：双击表格中的一个互斥开关，在弹窗中即可编辑该互斥开关的名称

### 3.3 编辑功能开关
双击表格中的任意一行会弹出该行的编辑弹窗  

| 返回类型为 bool | 返回类型为非 bool |
| --------------- | ------------------ |
| ![alt text](image-9.png)<br/>返回类型为 **bool** | ![alt text](image-10.png)<br/>返回类型为 **非bool** |

- 在弹窗中，可以修改功能名和默认值
- 返回类型为bool时，可以选择是否设置互斥开关
- 返回类型不为bool时：  
  - 可以新增键值对  
  - 默认值只能从已有的键值对中选择  
  - 双击表格中的键值对会弹出该键值对的编辑弹窗  

## 4. 分组管理模块
- 管理每个分组开启哪些功能
![alt text](image-11.png)
### 4.1 新建分组
- 点击按钮后在弹窗中输入组描述即可新建分组
- 新建的分组的各个功能的返回值为各自的默认值
- 如果有多个bool类型的功能使用了同一个互斥开关，且默认值都为true，那么无法创建新的分组

### 4.2 编辑分组
- 双击第一行，可以在弹窗中修改该组的描述
- 双击其他行，可以在弹窗中修改功能的返回值  

| 返回类型为 bool | 返回类型为非 bool |
| --------------- | ------------------ |
| ![alt text](image-12.png)<br/>返回类型为 **bool** | ![alt text](image-13.png)<br/>返回类型为 **非bool** |

- 对于返回值类型为bool的，双击的结果是将其由“关闭”转为“开启”或由“开启”转为“关闭”。
- 对于返回值类型不为bool的：  
  - 修改返回值：在下拉栏中选择该功能在当前分组中的返回值。  
  - 增加更多的可选返回值：在“功能开关模块”的表格中双击一个功能，在弹窗中点击“新增键值对”。  
  - 恢复默认值：将当前功能在当前分组中的返回值设置为该功能的默认值  

## 5. 版本管理模块
- 管理版本开启哪些分组，以及新用户分配分组时的权重
![alt text](image-14.png)
### 5.1 添加版本
点击左上角“添加版本”按钮，输入版本号和版本描述即可创建一个版本

### 5.2 编辑版本

#### 5.2.1 编辑版本描述
双击表格第一行，在弹窗中即可编辑版本描述

#### 5.2.2 是否平均权重
- 平均权重时，启用的各个分组的权重是相同的，不能手动编辑权重
- 非平均权重时，需要手动设置各个分组的权重，当权重总和不为100%时，会标红。精度为百分制下小数点后两位
- 如果最新版本的权重总和不为100%，那么无法导出。

#### 5.2.3 启用分组
双击某一个分组会弹出相应的编辑窗口  
- 当该版本处于平均权重模式时，双击的结果是简单的修改是否启用该分组  
- 当该版本处于非平均权重模式时，在弹窗中可以勾选“是否启用分组”，如果启用了该分组，那么还需要输入其权重  
![alt text](image-15.png)![alt text](image-16.png)|

## 6. 分组更新模块
- 老用户更新时，弃用老的分组，给老用户一个分组映射关系
![alt text](image-17.png)
- 该模块可以将一个分组映射到另一个分组。
- 左侧表格中是目前已有的映射，右侧表格中是最终的映射。导出时只会导出右侧表格中的最终映射规则
- 无论是在新建映射还是在编辑映射时，都不能：  
  - 自我映射：一个分组映射到它自己  
  - 循环映射：映射规则形成一个环，比如A->B, B->A  
  - 一对多的映射：A既映射到B，又映射到C。  

### 6.1 新建映射
点击“新建映射”按钮，选择原始分组和映射分组，即可创建一个映射
![alt text](image-18.png)
### 6.2 编辑映射
双击左侧表格的任意一行会弹出该行的编辑弹窗
![alt text](image-19.png)
## 7. 导出代码的使用

### 7.1 获取用户初始分组，传递给统计工具

```cpp
ABTest::getInstance()->getInitialGroup();
```

### 7.2 功能开关的使用

```cpp
if(ABTest::getInstance()->isNoAngleLimit()){
    .....
} else {
    .....
}
```

```cpp
int dis = ABTest::getInstance()->getCameraPosToTargetDist();
```

### 7.3 调试时强制进入某个分组

```cpp
ABTest::getInstance()->setCurrentGroupForDebug(12);
```